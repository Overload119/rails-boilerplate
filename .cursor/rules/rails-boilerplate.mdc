---
description: How to bootstrap, run, test, and safely change this Rails + Inertia/React + Bun app
globs: **/*
---

## Repo map (what this is)

- **Backend**: Rails 8 (`app/`, `config/`, `db/`) with Postgres (`config/database.yml`).
- **Jobs**: Sidekiq + sidekiq-cron + unique jobs (`config/initializers/sidekiq.rb`, `config/sidekiq_schedule.yml`). Redis URL via `REDIS_URL`.
- **Frontend**: Inertia.js + React (`app/javascript/`). Tailwind CSS 4.
- **Bundling/build**: Bun builds JS/CSS into `app/assets/builds/` (that folder is **generated and gitignored**).

## Setup (local dev)

Use binstubs when available (`bin/rails`, `bin/rubocop`, etc.).

1. Install dependencies

- **Ruby gems**:
  - `bundle install`
- **JS deps (Bun)**:
  - `bun install`

2. Configure environment

- Copy the sample env file (present as `.env.example`) to `.env` and adjust as needed.
- Common env vars used by this app:
  - **Database**: `POSTGRES_HOST`, `POSTGRES_USER`, `POSTGRES_PASSWORD`, `RAILS_MAX_THREADS`
  - **Redis/Sidekiq**: `REDIS_URL`, `SIDEKIQ_CONCURRENCY`
  - **Jobs (Solid Queue config exists too)**: `JOB_CONCURRENCY`

3. Prepare DB

- `bin/rails db:prepare`

## Run (local dev)

- `bin/dev`
  - Builds assets once (`bun run build`) then starts processes from `Procfile.dev`:
    - Rails server on port **3000**
    - JS/CSS watchers
    - Sidekiq worker

### Required services

- **Postgres** must be running locally.
- **Redis** must be running locally (Sidekiq uses `REDIS_URL`, defaults to `redis://localhost:6379/0`).

## Build assets (manual)

- Production-ish minified build: `bun run build`
- Dev builds (non-minified) and typecheck:
  - `bun run build:dev`
  - `bun run typecheck`

**Do not edit** files in `app/assets/builds/` directly—edit sources under `app/javascript/`.

## Testing

This repo has both Minitest and RSpec:

### CI-style (Minitest + system tests)

- `bin/rails db:test:prepare test test:system`

System tests use Selenium/Capybara and require a Chrome installation locally (CI installs `google-chrome-stable`).

### RSpec (request/model specs exist)

- `bundle exec rspec`

## Linting / checks

- **Ruby style**: `bin/rubocop`
- **Ruby formatting**: `bun run format:ruby` / `bun run format:ruby:check` (uses `@prettier/plugin-ruby`)
- **Ruby security**: `bin/brakeman --no-pager`
- **JS formatting**: `bun run format` / `bun run format:check`
- **TypeScript**: `bun run typecheck`

## Inertia/React specifics (important for changes)

- **Inertia page resolution is manual** because Bun doesn’t support `import.meta.glob`.
  - When adding a new page, you must:
    - Create it under `app/javascript/pages/...`
    - Import it in `app/javascript/inertia.tsx`
    - Add it to the `pages` map with the correct key (e.g. `"Todos/Index"`).
- Shared props:
  - Flash messages are shared from `InertiaFlash` and displayed in `AppLayout`.

## AI working rules (how to make changes safely here)

- Prefer **binstubs** (`bin/rails`, `bin/rubocop`, etc.) and repo scripts over ad-hoc commands.
- Do not modify generated artifacts (`app/assets/builds/*`, `db/schema.rb` edits by hand). Use migrations and build scripts.
- Keep backend/UI behavior consistent with existing patterns:
  - Rails controllers redirect with flash; Inertia pages read `flash` from shared props.
- When changing the UI, also consider updating:
  - System tests in `test/system/`
  - Request/model specs in `spec/`
- Before finishing a change, run the **smallest relevant** checks:
  - Ruby change → `bin/rubocop` and relevant tests
  - JS/TS change → `bun run typecheck` (and `bun run format:check` if formatting-sensitive)
  - Full confidence → CI-style test command above

## Cursor/AI rules best practices (for this repo)

- Keep project rules as `.mdc` files directly under `.cursor/rules/` (avoid subdirectories).
- Keep frontmatter minimal (just `description` + `globs`) to avoid Cursor rule-editor quirks/conflicts.
- Prefer instructions that are **actionable and repo-specific** (commands, file paths, conventions) over generic advice.
